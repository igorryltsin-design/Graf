# Графовая MLS/ABAC-песочница

Учебное одностраничное приложение демонстрирует многоуровневое управление доступом (MLS) и атрибутно-ориентированные политики (ABAC) на базе графовых данных. Пользователь работает с интерактивной визуализацией объектов, выполняет естественно-языковые запросы и видит ограничения, накладываемые бюджетами запросов и k-анонимностью.

---

## Основные возможности
- визуализация знаний в виде графа с режимами: виртуальная агрегация версий, просмотр конкретного уровня допуска и наложение уровней;
- редактирование онтологии прямо в браузере: добавление/удаление вершин и связей, управление атрибутами;
- учебный режим с прогрессом по заданиям (исчерпать бюджет, вызвать k-анонимность, разобрать журнал);
- обработка запросов на русском и английском языках с разбором сущностей, фильтров, временных окон и сравнений;
- защита данных: проверка допуска, проверка сектора, контроль бюджета запросов и блокировка при нарушении k-анонимности;
- журнал аудита с мгновенной расшифровкой причин отказа;
- экспорт/импорт данных по уровням допуска для демонстраций и сценариев «что если».

---

## Стек и структура проекта
- **Веб-стек:** React 18, TypeScript, Vite 5, Tailwind CSS, vis-network, lucide-react.
- **Данные и логика:** In-memory-«Supabase» на базе `project/src/lib/dataStore.ts` и JSON-заготовок; никакого внешнего бэкенда не требуется.
- **Сборка:** `npm run build` (Vite) → статический бандл в `project/dist`.
- **Контейнеризация:** двухэтапный `Dockerfile` (Node 20 + nginx) с поддержкой `--platform`.

Структура ключевых каталогов:
- `project/src/App.tsx` — переключение между экраном входа и рабочим столом.
- `project/src/components/` — виджеты интерфейса (граф, панель запросов, журнал).
- `project/src/lib/`:
  - `queryEngine.ts` — парсер и исполнитель естественных запросов, выдаёт объяснения.
  - `policy.ts` — проверка допуска и сектора, k-анонимность, бюджет запросов.
  - `dataStore.ts` — in-memory-хранилище сущностей/связей и журнал аудита.
- `project/src/data/graphData.ts` — исходные данные по уровням L/M/H.
- `project/src/data/usersData.ts` — учебные учётные записи, лимиты и сектора.
- `project/Dockerfile` — продакшн-статик для nginx.

---

## Учётные записи и сценарии

| Пользователь | Уровень | Сектора | Бюджет | Назначение |
|--------------|---------|---------|--------|------------|
| `analyst_a`  | CONFIDENTIAL (M) | A | 8 | Аналитик сектора A, быстро упирается в бюджет и k-анонимность |
| `commander`  | SECRET (H) | A / B / C | 20 | Командир, доступ ко всем данным и уровням |

Вход выполняется по имени пользователя без пароля. Быстрые кнопки доступны на экране логина. После перерасхода лимита таймер восстановления отображается в панели прогресса.

---

## Интерфейс рабочего стола
- **Верхняя панель:** выбор режима отображения графа (`Виртуальный`, `Уровень`, `Совместный обзор`), переключение уровней/наложений, индикатор бюджета.
- **Граф:** раскладка `vis-network`, подсветка уровней, закрепление узлов, фильтрация по типам сущностей и уровням, временная шторка (timeline) с прокруткой и автопрокруткой.
- **Контекстное меню (ПКМ):** добавление вершин, построение связей, удаление сущностей/дуг в пределах доступного уровня.
- **Панель запросов:** история, повторное выполнение, подсветка узлов по результату, экспорт журнала запросов в JSON.
- **Журнал аудита:** список успешных и отказанных запросов, подсказки по устранению причин (например, k-анонимность).
- **Импорт/экспорт уровня:** сохранение и загрузка срезов уровней безопасности (кнопки «Экспорт»/«Импорт»).

Все изменения живут в памяти браузера и сбрасываются при перезагрузке страницы — удобно для демонстраций.

---

## Обработка естественных запросов

Логика реализована в `project/src/lib/queryEngine.ts`. Последовательность:
1. **Проверка бюджета:** `checkQueryBudget` из `policy.ts` блокирует работу при `query_budget = 0`, запись попадает в аудит с кодом `BUDGET_EXHAUSTED`.
2. **Парсинг текста:** `parseNaturalLanguage` ищет ключевые слова сущностей (Target, Sensor, Event, Sector), сектора (рус/англ), уровни допуска, статусы, категории, числовые сравнения (`скорость > 200`) и временные окна (`последние 2 часа`, диапазоны `10:15-11:00`, радиусы по координатам).
3. **Фильтрация данных:**
   - очистка по уровню допуска и сектору (`filterAccessibleNodes`/`filterAccessibleEdges`);
   - применение фильтров сектора/уровня/категории/статуса, временных ограничений и сравнения атрибутов;
   - учёт геозоны (радиус по координатам) и лимита `top N`.
4. **k-анонимность:** если результатов `< 2`, система возвращает агрегат (`count`) и помечает аудит кодом `K_ANONYMITY`.
5. **Формирование объяснения:** `buildExplanation` возвращает распознанные сущности, фильтры, сравнения, временные окна и дружелюбные подсказки.

Поддерживаются намерения:
- `list` — подробный список объектов (по умолчанию);
- `count` — агрегация (фразы вида «сколько», `limit 0`);
- `timeline` — сортировка по времени для событий.

Запросы возвращают:
- `success: true/false`;
- `data`: массив узлов или агрегат с полем `count`;
- `aggregated: true`, если данные из-за k-анонимности обезличены;
- `explanation`: структура для отображения в UI.

---

## Примеры запросов
- «Сколько беспилотников в секторе A за последний 1 час»
- «Какие сенсоры недоступны в секторе A»
- «Покажи события в секторе B между 09:30 и 10:00»
- «Цели с угрозой high или medium в секторе C»
- «Объекты в радиусе 15 км от 54.2101;37.52»

При узкой выборке (`< 2` объектов) ответ будет в виде счётчика без раскрытия атрибутов.

---

## Локальный запуск (режим разработки)

Необходимы Node.js ≥ 20 и npm.

```bash
cd project
npm install
npm run dev
```

Vite запустится на `http://localhost:5173/`. Линтер и проверка типов:

```bash
npm run lint
npm run typecheck
```

---

## Сборка prod-бандла

```bash
cd project
npm run build
npm run preview      # локальная проверка собранной статики
```

Сборка появится в `project/dist` и готова к раздаче любым веб-сервером.

---

## Docker: сборка и запуск под amd64

`project/Dockerfile` уже содержит двухэтапную сборку. Для гарантированной сборки с архитектурой `linux/amd64` используйте `buildx`:

```bash
cd project
docker buildx build \
  --platform linux/amd64 \
  -t graf-mls:latest \
  .
```

Запуск контейнера:

```bash
docker run --rm -p 8080:80 graf-mls:latest
```

После этого приложение доступно по адресу `http://localhost:8080/`. При необходимости добавьте теги (`-t graf-mls:v1`) или экспортируйте образ в tar (`--output type=docker`).

---

## Работа с данными
- **Редактирование графа:** через ПКМ добавляйте вершины/связи внутри доступного уровня. Для переключения уровней используйте меню `Уровень отдельно`.
- **Экспорт/импорт:** кнопки в правой панели сохраняют JSON выбранного уровня (структура соответствует `exportLevelData`/`importLevelData`).
- **Инициализация данных:** правки можно внести в `project/src/data/graphData.ts` и `project/src/data/usersData.ts`, затем пересобрать приложение.
- **Журнал аудита:** хранится в памяти (`dataStore.ts`). Файл не создаётся, очистка — перезагрузка страницы.

---

## Расширение и кастомизация
- Добавление новых типов сущностей и словаря для парсера — обновите `ENTITY_KEYWORDS`, `STATUS_KEYWORDS`, `CATEGORY_KEYWORDS` и `ATTRIBUTE_ALIASES` в `queryEngine.ts`.
- Изменение правил доступа — правьте `policy.ts` (например, расширьте логику `checkSectorAccess`).
- Включение дополнительных режимов визуализации — используйте `GraphView.tsx` (например, собственные фильтры или альтернативные легенды).
- Интеграция со внешним бэкендом — замените вызовы из `lib/supabase.ts` своими API-клиентами, сохранив сигнатуры.

---

## Советы по демонстрации
- Начните с пользователя `analyst_a`, выполните несколько узконаправленных запросов до блокировки бюджета, затем переключитесь на `commander`.
- Покажите разницу между режимами `Виртуальный уровень` и `Совместный обзор`, отметьте, как выбирается лучшая доступная версия узла.
- Используйте запросы с координатами и временными окнами, чтобы продемонстрировать распознавание сложных фильтров.
- Включите учебный режим — индикатор прогресса подсказывает, какие механики уже раскрыты слушателям.

---

## Лицензия и статус
Проект предназначен для демонстрационных и учебных целей; внешних зависимостей, требующих дополнительного лицензирования, нет. Используйте и модифицируйте свободно под свои сценарии.
